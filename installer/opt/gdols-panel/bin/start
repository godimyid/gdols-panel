#!/bin/bash
##############################################################################
# GDOLS Panel - Start Script
# Location: /opt/gdols-panel/bin/start
# Description: Start the GDOLS Panel service
##############################################################################

set -e

# Configuration
APP_NAME="GDOLS Panel"
APP_VERSION="1.1.0"
BASE_DIR="/opt/gdols-panel"
CONFIG_FILE="/etc/gdols/gdols.conf"
PID_FILE="/var/lib/gdols/runtime/gdols-panel.pid"
LOG_FILE="/var/log/gdols/panel.log"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Function to print colored messages
print_message() {
    local color=$1
    local message=$2
    echo -e "${color}[$(date +'%Y-%m-%d %H:%M:%S')]${NC} $message"
}

# Function to check if service is already running
is_running() {
    if [ -f "$PID_FILE" ]; then
        PID=$(cat "$PID_FILE")
        if ps -p "$PID" > /dev/null 2>&1; then
            return 0
        else
            rm -f "$PID_FILE"
            return 1
        fi
    fi
    return 1
}

# Function to create necessary directories
create_directories() {
    print_message "$BLUE" "Creating necessary directories..."

    mkdir -p /var/lib/gdols/runtime
    mkdir -p /var/lib/gdols/backups
    mkdir -p /var/lib/gdols/backups/database
    mkdir -p /var/log/gdols

    # Create storage directories
    mkdir -p "$BASE_DIR/storage/cache"
    mkdir -p "$BASE_DIR/storage/sessions"
    mkdir -p "$BASE_DIR/storage/uploads"
    mkdir -p "$BASE_DIR/logs"

    # Set permissions
    chmod 750 /var/lib/gdols
    chmod 750 /var/log/gdols
    chmod -R 755 "$BASE_DIR/storage"

    print_message "$GREEN" "Directories created successfully"
}

# Function to check dependencies
check_dependencies() {
    print_message "$BLUE" "Checking dependencies..."

    # Check PHP
    if ! command -v php &> /dev/null; then
        print_message "$RED" "PHP is not installed. Please install PHP 8.3 or higher."
        exit 1
    fi

    # Check MariaDB/MySQL
    if ! command -v mysql &> /dev/null; then
        print_message "$YELLOW" "MariaDB/MySQL client not found. Database features may not work."
    fi

    # Check Redis
    if ! command -v redis-cli &> /dev/null; then
        print_message "$YELLOW" "Redis client not found. Caching features may not work."
    fi

    # Check configuration file
    if [ ! -f "$CONFIG_FILE" ]; then
        print_message "$YELLOW" "Configuration file not found at $CONFIG_FILE"
        print_message "$YELLOW" "Creating default configuration..."
        mkdir -p /etc/gdols
        cp "$BASE_DIR/config/gdols.conf.example" "$CONFIG_FILE" 2>/dev/null || true
    fi

    print_message "$GREEN" "Dependencies check completed"
}

# Function to start the panel
start_panel() {
    print_message "$BLUE" "Starting $APP_NAME v$APP_VERSION..."

    # Check if already running
    if is_running; then
        print_message "$YELLOW" "$APP_NAME is already running (PID: $(cat $PID_FILE))"
        exit 0
    fi

    # Create directories
    create_directories

    # Check dependencies
    check_dependencies

    # Start PHP built-in server (for development)
    # In production, this should be handled by OpenLiteSpeed
    if [ "$GDOLS_PANEL_ENV" = "development" ]; then
        print_message "$BLUE" "Starting PHP development server..."
        nohup php -S localhost:8080 -t "$BASE_DIR/public" >> "$LOG_FILE" 2>&1 &
        echo $! > "$PID_FILE"
        print_message "$GREEN" "$APP_NAME development server started successfully"
        print_message "$GREEN" "Access the panel at: http://localhost:8080"
    else
        # Production mode - just write PID to indicate service is active
        # The actual web serving is handled by OpenLiteSpeed
        echo $$ > "$PID_FILE"

        # Start background processes (cron jobs, monitoring, etc.)
        php "$BASE_DIR/scripts/monitor.php" >> "$LOG_FILE" 2>&1 &

        print_message "$GREEN" "$APP_NAME started successfully"
        print_message "$GREEN" "Web interface is served by OpenLiteSpeed"
    fi

    # Display service information
    echo ""
    print_message "$BLUE" "Service Information:"
    echo "  - Name: $APP_NAME"
    echo "  - Version: $APP_VERSION"
    echo "  - Base Directory: $BASE_DIR"
    echo "  - Configuration: $CONFIG_FILE"
    echo "  - Log File: $LOG_FILE"
    echo "  - PID File: $PID_FILE"
    echo ""
}

# Main execution
main() {
    # Check if running as root
    if [ "$EUID" -ne 0 ]; then
        print_message "$RED" "Please run as root or with sudo"
        exit 1
    fi

    # Start the panel
    start_panel
}

# Run main function
main "$@"
