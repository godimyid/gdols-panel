#!/bin/bash
##############################################################################
# GDOLS Panel - Quick Static Files Fix
# Description: Quick fix for static file serving issues
# Version: 1.1.0
##############################################################################

INSTALL_DIR="/opt/gdols-panel"

# Color codes
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

echo -e "${BLUE}═══════════════════════════════════════════════════════════════${NC}"
echo -e "${BLUE}  GDOLS Panel - Quick Static Files Fix${NC}"
echo -e "${BLUE}═══════════════════════════════════════════════════════════════${NC}"
echo ""

# Check root
if [ "$EUID" -ne 0 ]; then
    echo -e "${RED}✗ Please run as root or with sudo${NC}"
    exit 1
fi

# Detect web server
if systemctl is-active --quiet lsws 2>/dev/null || command -v lshttpd &> /dev/null; then
    WEB_SERVER="openlitespeed"
    WEB_USER="nobody"
    WEB_GROUP="nogroup"
    echo -e "${GREEN}✓ OpenLiteSpeed detected${NC}"
elif systemctl is-active --quiet apache2 2>/dev/null; then
    WEB_SERVER="apache"
    WEB_USER="www-data"
    WEB_GROUP="www-data"
    echo -e "${GREEN}✓ Apache detected${NC}"
elif systemctl is-active --quiet nginx 2>/dev/null; then
    WEB_SERVER="nginx"
    WEB_USER="www-data"
    WEB_GROUP="www-data"
    echo -e "${GREEN}✓ Nginx detected${NC}"
else
    WEB_SERVER="unknown"
    WEB_USER="www-data"
    WEB_GROUP="www-data"
    echo -e "${YELLOW}⚠ No web server detected, using default${NC}"
fi

# Fix ownership
echo ""
echo -e "${BLUE}Fixing ownership for $WEB_SERVER...${NC}"
chown -R "$WEB_USER:$WEB_GROUP" "$INSTALL_DIR/public" 2>/dev/null && echo -e "${GREEN}✓ Ownership fixed${NC}" || echo -e "${RED}✗ Failed to set ownership${NC}"
chmod -R 755 "$INSTALL_DIR/public" 2>/dev/null && echo -e "${GREEN}✓ Permissions fixed${NC}" || echo -e "${RED}✗ Failed to set permissions${NC}"

# Fix vhost for OpenLiteSpeed
if [ "$WEB_SERVER" = "openlitespeed" ]; then
    echo ""
    echo -e "${BLUE}Fixing OpenLiteSpeed virtual host...${NC}"
    if [ -d "/usr/local/lsws/vhosts/gdols-panel" ]; then
        chown -R "$WEB_USER:$WEB_GROUP" /usr/local/lsws/vhosts/gdols-panel 2>/dev/null
        chmod -R 755 /usr/local/lsws/vhosts/gdols-panel 2>/dev/null
        echo -e "${GREEN}✓ VHost permissions fixed${NC}"
    fi

    # Fix symlink
    if [ -L /usr/local/lsws/vhosts/gdols-panel/html ]; then
        if [ ! -e /usr/local/lsws/vhosts/gdols-panel/html ]; then
            echo -e "${YELLOW}⚠ Broken symlink detected, recreating...${NC}"
            rm -f /usr/local/lsws/vhosts/gdols-panel/html
            ln -sf "$INSTALL_DIR/public" /usr/local/lsws/vhosts/gdols-panel/html
            echo -e "${GREEN}✓ Symlink recreated${NC}"
        fi
    else
        mkdir -p /usr/local/lsws/vhosts/gdols-panel
        ln -sf "$INSTALL_DIR/public" /usr/local/lsws/vhosts/gdols-panel/html
        echo -e "${GREEN}✓ Symlink created${NC}"
    fi
fi

# Restart web server
echo ""
echo -e "${BLUE}Restarting web server...${NC}"
if [ "$WEB_SERVER" = "openlitespeed" ]; then
    systemctl restart lsws 2>/dev/null && echo -e "${GREEN}✓ OpenLiteSpeed restarted${NC}" || echo -e "${RED}✗ Failed to restart${NC}"
elif [ "$WEB_SERVER" = "apache" ]; then
    systemctl restart apache2 2>/dev/null && echo -e "${GREEN}✓ Apache restarted${NC}" || echo -e "${RED}✗ Failed to restart${NC}"
elif [ "$WEB_SERVER" = "nginx" ]; then
    systemctl restart nginx 2>/dev/null && echo -e "${GREEN}✓ Nginx restarted${NC}" || echo -e "${RED}✗ Failed to restart${NC}"
fi

# Verification
echo ""
echo -e "${BLUE}═══════════════════════════════════════════════════════════════${NC}"
echo -e "${BLUE}  Verification${NC}"
echo -e "${BLUE}═══════════════════════════════════════════════════════════════${NC}"

# Check files
echo ""
echo -e "${BLUE}Checking static files...${NC}"
if [ -f "$INSTALL_DIR/public/assets/css/style.css" ]; then
    SIZE=$(stat -c%s "$INSTALL_DIR/public/assets/css/style.css" 2>/dev/null || echo "0")
    echo -e "${GREEN}✓ CSS file exists ($SIZE bytes)${NC}"
    ls -lh "$INSTALL_DIR/public/assets/css/style.css" | awk '{print "  Owner: " $3 ":" $4}'
else
    echo -e "${RED}✗ CSS file not found${NC}"
fi

if [ -f "$INSTALL_DIR/public/assets/js/app.js" ]; then
    SIZE=$(stat -c%s "$INSTALL_DIR/public/assets/js/app.js" 2>/dev/null || echo "0")
    echo -e "${GREEN}✓ JS file exists ($SIZE bytes)${NC}"
    ls -lh "$INSTALL_DIR/public/assets/js/app.js" | awk '{print "  Owner: " $3 ":" $4}'
else
    echo -e "${RED}✗ JS file not found${NC}"
fi

echo ""
echo -e "${BLUE}═══════════════════════════════════════════════════════════════${NC}"
echo ""
echo -e "${GREEN}✓ Static files fix completed!${NC}"
echo ""
echo -e "${BLUE}Test in browser:${NC}"
IP=$(hostname -I | awk '{print $1}')
echo -e "  ${YELLOW}http://$IP:8088/assets/css/style.css${NC}"
echo -e "  ${YELLOW}http://$IP:8088/assets/js/app.js${NC}"
echo ""
echo -e "${BLUE}For detailed troubleshooting, run:${NC}"
echo -e "  ${YELLOW}$INSTALL_DIR/scripts/fix-static-files.sh${NC}"
echo ""
